The i3 config file has very few scripting abilities, so you pretty much have to create your VM-command keybindings by hand.  The script 'i3gen.sh' in this directory automagically creates and adds the required lines to the config file, mapping your modes and keybindings, based on information you provide in the i3gen\_setup file.  It's fairly straight forward if you're familiar with i3.  If not, then you should read the [i3 user documentation](https://i3wm.org/docs/userguide.html), it's pretty good.  We'll cover how to use the setup files in a moment.

> Side Note: There's a little bug in the default config file generated by Qubes/i3 on the first run.  Search for `i3lock -d` and remove the \`-d' option.  It's deprecated, and caused once-per-day login freezes for me until I removed it.

## HOW THE BINDING MODES FUNCTION, ONCE ACTIVE IN YOUR i3 CONFIG

The idea is to select your target VM, and then select which command to run.  Depending on your number of VMs, keybind collisions happen pretty often if trying to define them all in the same mode.  So I grouped some of them into a "second layer" binding mode.  All of my system operation VMs are grouped (templates, \`sys-', \`dvm-', \`vpn-'), but my production daily use VMs are directly accessible from the first mode.  For example, the flow look like this:

1. mod+q enters the first binding mode, where you can either directly select a production VM, or a VM group.  From here:
  * `1` enters the binding mode designated for templates
  * `2` enters the binding mode designated for `sys-___` 
  * `3` enters the binding mode designated for `dvm-___`   
  * `4` enters the binding mode designated for `vpn-___` 
  * `<letter>` is reserved for production VMs... ***v***ault, ***w***ork, ***p***ersonal, ***s***ocialmedia, etc
  * `Enter` and `Escape` keys always bring you back to normal (default) mode regardless of which binding mode you're in. 

2. If you selected a grouped VM, you are now inside the group binding mode.  Hypothetically lets say you selected `1` (templates).  From here:
  * `f` enters the ***f***edora-31 specific mode (where you can select actual command to run). 
  * `d` enters ***d***ebian-10
  * `w` enters whonix-***w***s-15
  * `g` enters whonix-***g***w-15 
  * `k` enters deb-10-***k***de
> It might seem trivial or unnecessary to divide the system VMs into grouped modes like this.  I have quite a few additional sys- , dvm- , vpn- , VMs so it makes sense for me.  You could also make use of combining $mod with keys like Ctrl and Alt, to avoid subgroups if you want to.

3. Regardless of whether or not you transitioned through one of the grouped binding modes, you will now be inside a specific VM mode.  The i3-bar shows on the left, exactly which binding mode your currently in. From here, the command you select will be passed to the VM.  If you have a lot of commands/apps, you can again end up with collisions.  Rather than making yet another binding mode, I just set all the system-operation type stuff to numerical keys.  `<key> --\> <command>`
  * `1 --\> start` ; `2 --\> unpause` ; `3 --\> run_terminal` ; `4 --\> run_command_in_qube`
  * `5 --\> update` ; `6 --\> xterm_in_dispvm` ; `9 --\> pause` ; `0 --\> shutdown`
  * The letters are reserved for actual apps or functions like **b**rowser ; **l**iberoffice ; **k**eepass ; **p**hotos
  * **Press the corresponding letter, and watch your command take off!**

The convenience of controlling Qubes like this grows on you really quick.  And with this script, you can quickly/easily set your own custom keybinds, VMs, commands, and grouped binding modes.  You can imagine how much a PITA this would be to crank out by hand.  God forbid you add a VM, change a VM name, add some packages, or want to rearrange keybinds. 


## HOW TO CONFIGURE YOUR OWN CUSTOM BINDINGS

You need to edit the i3gen\_setup file, run `i3gen.sh`, and then reload the configuration file.  
All of these files go in `/home/user/.config/i3/`

**Columns in the first section (the VM list)**

1. EXACT VM name
2. GROUP
   * If you want to assign a group the VM to avoid collisions, add a group name
   * If you don't want the VM in a group, ***you MUST write `none` in this column***, or the script won't work correctly
3. BINDSYM TO NEXT MODE (This keypress will take you to the next mode)
   * If the GROUP is `none` this key will take you directly to the individual VM mode (command input)
   * If the GROUP is `<whatever>` this key will take you to the group submode
4. BINDSYM FOR SUBMODE
   * If GROUP is `none`, this column is ignored, BUT, ***you MUST put a character in this column***, or the script wont work correctly.  I just put a dash \`-' 
   * If GROUP is `<whatever>` this key press will move you from the group submode, to the individual VM, 
5. COMMAND ALIAS 
   * This of course isn't the exact command to be run, it's an alias, defined in the next section 
   * Comma separated, no spaces, list all of the commands you want for this VM 

**Columns in the second section (the alias-command list)**

1. ALIAS from the vmlist
2. BINDSYM (keypress) that will cause i3 to exec the command
3. COMMAND 
   * The EXACT command you want i3 to pass to dom0.
   * Notice the substitution of `$vm` for an actual VM name.  The script resolves this when creating the lines.  Use exactly `$vm` if making your own custom commands.

Be careful when creating your own commands.  It can be difficult to pass complex commands to a VM through the `qvm-run` interface; thoroughly test before adding them.  When in doubt, write a script to do the job and call the script.  

You'll notice there are commands in my i3gen\_setup which aren't part of the Qubes-i3 install.  They do cool things like update the selected template ; take a screenshot of a VM window *from within the VM itself and save it there* ; or my favorite, pass an arbitrary command to a target VM (similar to `Run command in Qube`).  You can find them, with descriptions in the "Scripts" directory of this repository.  Don't worry, the are a MUCH shorter read than this. 

**COMPLETING THE CONFIG**
1. Ok, so you have all your own VM names added, desired keybinds, and aliased commands.
2. Make sure i3gen.sh and i3gen\_setup are in `/home/user/.config/i3/`
3. Make a backup of your current config!
4. In dom0 terminal run the script , it'll take a few seconds.
5. Open your modified config, scroll down, do a sanity check.
6. Reload the i3 config (default keybinding to do this is `mod+Shift+c`

If everything went okay, your screen should flicker once, and then your bindings are in effect
  * If there was an error, i3 will have a bar at the top informing you
  * Unfortunately the error logs are only *kinda* helpful.

> If you made some mistake or if there's a bug in my script (impossible!), then you might face a situation after reload, where normal mode keypresses are navigting wildly, launching VMs/apps, and even using the terminal becomes impossible.  I had this happen once while developing this script.  Not to worry!!  Basically all Linux's come with multiple TTYS.  Press `Ctrl+Alt+F2` or `Ctrl+Alt+F3` to get to another console, where Xwindows isn't running (and thus, neither is i3).  Re-input your login credentials for dom0, then `pkill -15 i3` , restore your backup config (you did make a backup, right??), type `exit` , press `Ctrl+Alt+F1` to return to your original TTYS, which has your GUI login manager, and login again.  Worst case scenario, just delete the config file entirely, and when you login again, i3 auto-config will launch.


**Ok that about does it!  I think it took me almost as long to write the docs as it did to write the script.  I really hope that people find this useful.  If I get some good feedback, maybe I'll ask if the maintainers of the Qubes i3 repository want to add it.** 
